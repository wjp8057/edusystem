select * from(SELECT row_number() over(order by SCHEDULE.COURSENO+SCHEDULE.[GROUP]) as row,SCHEDULE.YEAR,
SCHEDULE.TERM,
SCHEDULE.COURSENO+SCHEDULE.[GROUP] AS kh,
COURSES.COURSENAME km,
SCHEDULE.ROOMNO jsh,
CLASSROOMS.JSN jsjc,
CLASSROOMS.SEATS zws,
SELECTED.ATTENDENTS yxkrs,
PLANESTIMATES.ESTIMATE gskbyjrszj
FROM SCHEDULE
JOIN CLASSROOMS ON SCHEDULE.ROOMNO=CLASSROOMS.ROOMNO
JOIN COURSES ON SCHEDULE.COURSENO=COURSES.COURSENO
JOIN /*某学期的实际选课人数*/
(
SELECT COURSENO,[GROUP],COUNT(*) AS ATTENDENTS
FROM R32
WHERE YEAR=:YONE AND TERM=:TONE
GROUP BY COURSENO,[GROUP]
) AS SELECTED ON SCHEDULE.COURSENO=SELECTED.COURSENO AND SCHEDULE.[GROUP]=SELECTED.[GROUP]
JOIN
(
/*开课计划中的指定入学年度和月份的上课班级的预计人数和*/
SELECT COURSENO,[GROUP],SUM(CLASSES.STUDENTS) AS ESTIMATE
FROM COURSEPLAN JOIN CLASSES ON COURSEPLAN.CLASSNO=CLASSES.CLASSNO
WHERE COURSEPLAN.YEAR=:YTWO AND COURSEPLAN.TERM=:TTWO
AND YEAR(CLASSES.YEAR)=:ENTERYEAR AND MONTH(CLASSES.YEAR)=:ENTERMONTH
GROUP BY COURSENO,[GROUP]
) AS PLANESTIMATES ON SCHEDULE.COURSENO=PLANESTIMATES.COURSENO AND SCHEDULE.[GROUP]=PLANESTIMATES.[GROUP]
WHERE SCHEDULE.YEAR=:YTHREE AND SCHEDULE.TERM=:TTHREE
AND CLASSROOMS.SEATS<SELECTED.ATTENDENTS+PLANESTIMATES.ESTIMATE
) as b where b.row between :start and :end